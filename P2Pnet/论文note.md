### 论文总结：重新思考人群中的计数与定位：一种纯粹基于点的框架

## 1. **传统方法的问题**

#### **1.1 密度图方法**

**问题**：这种方法只能告诉你大概有多少人，但没法告诉你具体每个人的位置。比如你知道有 100 人，但不知道他们具体站在哪。

**论文中强调了：密度图的最大缺点就是无法预测人的精确位置。**

#### **1.2 检测方法**：用框框标记每个人的头部。

**论文中强调检测方法的缺点为**：然而，考虑到仅提供点注释，这些方法依赖启发式估算真实的边界框，这种方法容易出错，甚至不可行

#### 1.3 评估指标

**论文中也提出了传统的评估指标的缺点：**

>**传统普遍认同的评估指标（MAE 和 MSE）：**
>缺点：仅衡量计数误差，完全忽略单张图像中估计误差的显著空间变化。
>
>- MAE：预测人数和真实人数的平均差值。
>  - **公式**：$ MAE = \frac{1}{N} \sum_{i=1}^N |P_i - G_i| $
>- MSE：预测误差的平方均值，**放大大误差的影响**
>  - **公式**：$ MSE = \sqrt{\frac{1}{N} \sum_{i=1}^N (P_i - G_i)^2} $
>
>**使用基于块（patch-level）或像素级的绝对计数误差：**
>缺点：仅提供粗糙的定位评估
>
>**现有的定位相关指标**：
>
>缺点：要么忽略人群中显著的密度变化，要么缺乏对重复预测的惩罚

**补充，nAP指标相对于上面传统指标的优点**

>#### 新指标 nAP 的改进
>
>密度归一化平均精度（nAP），解决了上述问题：
>
>- 综合评估定位和计数：既看预测点的位置准不准，也看人数对不对。
>- 引入密度归一化：根据人群密度调整匹配规则，人多的地方要求更小的误差，人少的地方允许更大误差。
>- 使用序列匹配：避免重复预测（一个真实点只匹配一个预测点）。



## 2. **论文的创新：P2PNet 方法**

**论文强调P2PNet目标是：预测的点与真实点的距离尽可能近，置信度分数尽可能高。副产品是，预测的人数与真实的人数也尽可能接近。**

核心思想是：**直接预测点（把预测位置和预测数目同时进行）**

#### 2.1 具体步骤

##### 步骤 1：点提案生成

**详细描述**：

点提案生成的目标是为输入图像生成一组初始的候选点（点提案），这些点覆盖整个图像，作为后续预测的起点。P2PNet采用基于网格的策略，确保点提案均匀分布且计算高效。

- **输入：**

  一张彩色人群图像 $ I \in \mathbb{R}^{H \times W \times 3} $

- **网格划分：**

  将图像划分为规则的网格，网格步幅为 $ S $（论文中通常取 $ S=8 $，即每 8 像素一个网格单元）。网格单元的数量为： $H' = \frac{H}{S}, \quad W' = \frac{W}{S}$ 例如，对于 $ 1024 \times 768 $ 的图像，网格尺寸为 $ \frac{1024}{8} \times \frac{768}{8} = 128 \times 96 $。

- **参考点生成：**

  在每个网格单元内，预定义 $ K $ 个参考点（论文中通常取 $ K=4 $）。这些点的初始位置在单元内均匀分布（例如，位于单元的四个象限中心）。每个参考点的坐标 $ p_i = (x_i, y_i) $ 基于网格单元的中心坐标和预定义偏移计算。

  总点提案数为： $N = H' \times W' \times K$ 例如，$ 128 \times 96 \times 4 = 49,152 $ 个点提案。

- **输出：**

  一组点提案 $ P = {p_i | i=1,2,...,N} $，其中每个 $ p_i = (x_i, y_i) $ 是图像平面上的二维坐标。点提案以一维序列形式存储，形状为 $ [N, 2] $（例如，$ [49,152, 2] $），表示 $ N $ 个点的 $ x $ 和 $ y $ 坐标。

**输出示例**（假设输入图像为 $ 1024 \times 768 $，步幅 $ S=8 $，每个单元 $ K=4 $ 个点）：

- 网格尺寸：$ 128 \times 96 $。
- 点提案总数：$ 128 \times 96 \times 4 = 49,152 $。
- 输出：点提案序列 $ P \in \mathbb{R}^{49,152 \times 2} $，每个点表示初始坐标 $ (x_i, y_i) $。

##### 步骤 2：特征提取与点预测

**详细描述**：

P2PNet 使用卷积神经网络（CNN）主干提取图像特征，随后通过两个并行分支进行点预测：回归分支调整点提案的位置，分类分支预测每个点的置信度。

- **输入：**
  - 彩色人群图像 $ I \in \mathbb{R}^{H \times W \times 3} $
  - 点提案 $ P = {p_i | i=1,2,...,N} $，来自步骤 1。
- **特征提取：**
  - 使用  VGG-16 处理输入图像，提取多尺度特征图。主干网络通过多层卷积和池化操作，将输入图像下采样到较低分辨率（例如，步幅为 8，输出分辨率为 $ \frac{H}{8} \times \frac{W}{8} $）。
  - 输出的特征图 $ F \in \mathbb{R}^{H' \times W' \times C} $，其中：
    - $ H' = \frac{H}{S} $，$ W' = \frac{W}{S} $（例如，$ 128 \times 96 $）。
    - $ C $ 是特征通道数（例如，VGG-16 的最后一层为 512）。
- **回归分支：**
  - 回归分支基于特征图 $ F $，通过一个卷积头（例如，3×3 卷积层）预测**每个点提案**的偏移量 $ \Delta p_i = (\Delta x_i, \Delta y_i) $。
  - 对于每个网格单元的 $ K $ 个点，输出 $ 2 \times K $ 个通道（每个点预测 $ x $ 和 $ y $ 偏移量）。卷积头输出形状为 $ H' \times W' \times (2 \times K) $（例如，$ 128 \times 96 \times 8 $，若 $ K=4 $）。
  - 最终的预测点坐标为： $\hat{p}_i = p_i + \Delta p_i$ 其中 $ \hat{p}_i = (\hat{x}_i, \hat{y}_i) $ 是调整后的坐标。
- **分类分支：**
  - 分类分支基于相同的特征图 $ F $，通过另一个卷积头（例如，3×3 卷积层后接 sigmoid 激活）预测每个点提案的置信度 $ s_i \in [0,1] $，表示该点对应真实个体的概率。
  - 输出形状为 $ H' \times W' \times K $（例如，$ 128 \times 96 \times 4 $，若 $ K=4 $），每个值表示对应点的置信度。
- **输出：**
  - **预测点**：调整后的点坐标 $ {\hat{p}_i | i=1,2,...,N} $，形状为 $ [N, 2] $（例如，$ [49,152, 2] $）。
  - **置信度**：每个点的置信度 $ {s_i | i=1,2,...,N} $，形状为 $ [N, 1] $（例如，$ [49,152, 1] $）。

##### 步骤 3：一对一匹配

**详细描述**：

一对一匹配的目标是将预测点与真实点进行关联，用于训练时的损失计算和评估时的性能度量。P2PNet 采用匈牙利算法实现一对一匹配，避免传统匹配策略的重复预测或漏检问题。

- **输入：**

  **预测点**：$ {\hat{p}_i | i=1,2,...,N} $，来自步骤 2（例如，$ N=49,152 $）。

  **置信度**：$ {s_i | i=1,2,...,N} $，来自步骤 2。

  **真实点**：地面真相点 $ {g_j | j=1,2,...,M} $，其中 $ M $ 是图像中真实个体的数量（例如，$ M=100 $ 表示 100 个人）。每个 $ g_j = (x_j, y_j) $ 表示一个人头中心坐标。

- **匹配成本：**

  定义匹配成本矩阵 $ C \in \mathbb{R}^{N \times M} $，其中元素 $ c_{ij} $ 表示预测点 $ \hat{p}_i $ 与真实点 $ g_j $ 的匹配成本：
  $$
  c_{ij} = \lambda_d \cdot \|\hat{p}_i - g_j\|_2 + \lambda_s \cdot (1 - s_i)
  $$

  - $ |\hat{p}_i - g_j|_2 $：欧几里得距离，衡量预测点与真实点的空间偏差。
  - $ 1 - s_i $：置信度惩罚，鼓励高置信度的点匹配真实点。
  - $ \lambda_d = 1 $，$ \lambda_s = 5 $（论文实验设置），平衡距离和置信度的贡献。

- **匈牙利算法：**

  - 使用匈牙利算法求解最优匹配，得到一组匹配对 $ \mathcal{M} = {(i, j)} $，其中每个预测点 $ \hat{p}_i $ 至多匹配一个真实点 $ g_j $，反之亦然。
  - 未匹配的预测点被视为负样本（背景），未匹配的真实点表示漏检。

- **输出：**

  - 匹配对集合 $ \mathcal{M} = {(i, j)} $，表示预测点 $ \hat{p}_i $ 与真实点 $ g_j $ 的对应关系。
  - 正样本：匹配的预测点，目标置信度为 1。
  - 负样本：未匹配的预测点，目标置信度为 0。

##### 步骤 4：损失函数优化

**详细描述**：

P2PNet 的损失函数包括回归损失和分类损失，分别优化点坐标和置信度。

- 输入：

  - **预测点**：$ {\hat{p}_i | i=1,2,...,N} $，来自步骤 2。
  - **置信度**：$ {s_i | i=1,2,...,N} $，来自步骤 2。
  - **匹配结果**：匹配对 $ \mathcal{M} = {(i, j)} $，来自步骤 3。
  - **真实点**：$ {g_j | j=1,2,...,M} $。

- **回归损失：**

  - 对于匹配的点对 $ (i, j) \in \mathcal{M} $，使用 L1 损失优化预测点 $ \hat{p}_i $ 与真实点 $ g_j $ 的坐标偏差：
    $$
    L_{\text{reg}} = \frac{1}{|\mathcal{M}|} \sum_{(i,j) \in \mathcal{M}} \|\hat{p}_i - g_j\|_1
    $$

    - $ |\hat{p}_i - g_j|_1 = |\hat{x}_i - x_j| + |\hat{y}_i - y_j| $，表示 $ x $ 和 $ y $ 坐标的绝对差之和。
    - $ |\mathcal{M}| $ 是匹配对数量

  - 回归损失鼓励预测点尽可能接近真实点，优化定位精度。

- **分类损失：**

  - 对于所有预测点，定义目标标签：

    - 正样本（匹配的点）：$ y_i = 1 $。
    - 负样本（未匹配的点）：$ y_i = 0 $。

  - 使用二元交叉熵损失优化置信度：
    $$
    L_{\text{cls}} = -\frac{1}{N} \sum_{i=1}^N \left[ y_i \log(s_i) + (1 - y_i) \log(1 - s_i) \right]
    $$

    - 正样本的置信度 $ s_i $ 被优化接近 1，负样本接近 0。

  - 分类损失确保模型正确区分真实个体和背景。

- **总损失：**

  - 结合回归和分类损失：
    $$
    L = \lambda_{\text{reg}} \cdot L_{\text{reg}} + \lambda_{\text{cls}} \cdot L_{\text{cls}}
    $$

    - $ \lambda_{\text{reg}} = 1 $，$ \lambda_{\text{cls}} = 1 $（论文实验设置），平衡两个任务的贡献。

- **输出：**

  - 优化后的模型参数，使预测点 $ \hat{p}_i $ 在位置上接近真实点 $ g_j $，置信度 $ s_i $ 准确反映点的正负属性。
  - 训练过程中，模型学习调整点提案的位置和置信度，以最小化损失。

##### 步骤 5：推理与结果输出

**详细描述**：

推理阶段的目标是使用训练好的 P2PNet 模型处理新图像，输出人群的点位置和计数结果，无需复杂后处理。

- 输入：
  - 测试图像 $ I \in \mathbb{R}^{H \times W \times 3} $（例如，$ 1024 \times 768 \times 3 $）。
- 前向传播：
  - **点提案生成**：同步骤 1，生成点提案 $ P = {p_i} $（例如，$ 49,152 $ 个点）。
  - **特征提取与点预测**：同步骤 2，通过 CNN 主干和两个分支，输出预测点 $ {\hat{p}_i} $ 和置信度 $ {s_i} $。
  - **置信度筛选：**
    - 设定置信度阈值 $ \tau $（论文中通常取 $ \tau=0.5 $）。
    - 筛选高置信度点：$ \mathcal{P}_{\text{final}} = {\hat{p}_i | s_i > \tau} $。
- **人群计数：**
  - 统计高置信度点的数量作为预测人数： $\text{Count} = |\mathcal{P}_{\text{final}}|$
- **定位结果：**
  - 高置信度点的坐标 $ \mathcal{P}_{\text{final}} = {(\hat{x}_i, \hat{y}_i)} $ 直接表示每个个体的位置（例如，人头中心）。
- **输出：**
  - **人群计数**：预测的总人数（例如，100 人）。
  - **定位结果**：高置信度点的坐标集合，例如，$ \mathcal{P}_{\text{final}} \in \mathbb{R}^{100 \times 2} $，表示 100 个人的位置。



## 3. **新的评价指标：nAP**

 **nAP**（density Normalized Average Precision，密度归一化平均精度）。借鉴的是mAP（mean Average Precision）

#### 3.1 计算nAp

##### 1. **准备输入数据**

- 输入
  - 预测点集合 $  \hat{\mathcal{P}} = \{\hat{p}_j \mid j \in \{1, \ldots, M\}\}  $，每个预测点 $  \hat{p}_j = (\hat{x}_j, \hat{y}_j)  $ 表示模型预测的头部位置，附带一个置信度 $  \hat{c}_j  $（范围 0 到 1，比如 0.9 表示 90% 确信这里有个人）。
  - 真实点集合 $  \mathcal{P} = \{p_i \mid i \in \{1, \ldots, N\}\}  $，每个真实点 $  p_i = (x_i, y_i)  $ 表示标注的头部位置。



##### 2. **按置信度排序预测点**

- 将所有预测点 $  \hat{\mathcal{P}}  $ 按照置信度 $  \hat{c}_j  $ 从高到低排序。



##### 3. **计算每个真实点的密度（kNN 距离）**

- 对于每个真实点 $p_i$，计算它的 **k 最近邻距离**$d_{\mathrm{kNN}}(p_i)$：
  - 找到 $p_i$ 的 $k$ 个最近邻真实点（比如 $k=3$）。
  - 计算 $p_i$ 到这 $k$ 个邻居的平均欧几里得距离。
- **公式**： $d_{\mathrm{kNN}}(p_i) = \frac{1}{k} \sum_{\text{top } k \text{ neighbors of } p_i} \|p_i - p_{\text{neighbor}}\|_2$ 其中 $  \|p_i - p_{\text{neighbor}}\|_2  $ 是欧几里得距离： $\|p_i - p_{\text{neighbor}}\|_2 = \sqrt{(x_i - x_{\text{neighbor}})^2 + (y_i - y_{\text{neighbor}})^2}$



##### 4. **序列匹配：判断预测点是 TP 还是 FP**

正样本就是TP，负样本就是FP

- 按照置信度从高到低，依次检查每个预测点 $\hat{p}_j$：
  - 找到离 $  \hat{p}_j  $ 最近的真实点 $  p_i  $（用欧几里得距离 $  d(\hat{p}_j, p_i) = \|\hat{p}_j - p_i\|_2  $）。
  - 检查这个真实点 $p_i$ 是否已经被之前的预测点（置信度更高的）匹配过：
    - 如果 $  p_i  $ 已经被匹配过，$  \hat{p}_j  $ 就是 **False Positive (FP)**（错误的预测）。
    - 如果 $  p_i  $ 还没被匹配，计算归一化距离： $\text{归一化距离} = \frac{d(\hat{p}_j, p_i)}{d_{\mathrm{kNN}}(p_i)}$
    - 比较归一化距离和阈值 $\delta$（比如 $\delta = 0.5$:允许的偏差是 $d_{\mathrm{kNN}}(p_i)$ 的一半）：
      - **如果** $  \frac{d(\hat{p}_j, p_i)}{d_{\mathrm{kNN}}(p_i)} < \delta  $：$  \hat{p}_j  $ 是 **True Positive (TP)**（正确的预测），并标记 $  p_i  $ 为已匹配。
      - **否则**：$  \hat{p}_j  $ 是 **False Positive (FP)**。

>其实，在上面的匹配过程中，所用的“距离”可以不仅限于像素距离，也可以是**像素距离与置信度的组合成本函数**。我们在实验证明：在一对一匹配中**引入置信度作为匹配依据，有助于提升 nAP 指标的表现**。
>
>举例说明，设有两个预测点围绕同一个真实点 $p_i$：
>
>- 如果两者置信度一样，则应该优先将距离更近的点匹配为正样本，其它点为负样本，防止重复匹配。
>- 如果两者距离一样，则置信度更高的预测点应被匹配为正样本，并被进一步优化以获得更高精度和更高置信度。



##### 5. **计算精度和召回率，画 PR 曲线**

- 遍历所有预测点后，得到一个二进制列表：1 表示 TP，0 表示 FP。
- 计算累计的精度（Precision）和召回率（Recall）：
  - **Precision**：当前检查的点中，正确的比例。 $\text{Precision} = \frac{\text{累积 TP 数量}}{\text{累积 TP 数量} + \text{累积 FP 数量}}$
  - **Recall**：当前检查的点中，找到的真实点的比例。 $\text{Recall} = \frac{\text{累积 TP 数量}}{\text{真实点总数 } N}$
- 根据 Precision 和 Recall 画一条曲线（Precision-Recall 曲线）。
- **通俗解释**：你找了 100 个红点，其中 80 个是对的（TP），20 个是错的（FP），精度就是 $  80 / (80 + 20) = 0.8  $（80% 是对的）。召回率是 $  80 / 90 = 0.89  $（找到了 90 个真实点中的 80 个）。把这些点连成一条曲线。



##### 6. **计算 nAP**

- nAP 是 Precision-Recall 曲线下面的面积



##### 7. **多阈值 nAP**

- 论文中提到用不同的 $  \delta  $ 值（比如 0.05, 0.1, ..., 0.50）计算多个 nAP，然后取平均值，作为综合指标。

> 思考：论文中提到了nAP既可以评估定位也可以评估计数。nAP直接依赖于Precision和Recall，这两者直接依赖于真实点个数，TP和FP的个数.....



## 4. **实验结果：P2PNet表现如何？**

论文在几个数据集（比如 ShanghaiTech、UCF-QNRF、NWPU-Crowd）上测试了 P2PNet，结果非常好：

- **计数准确性**：
  - 在 ShanghaiTech PartA 数据集上，P2PNet 的 MAE（平均绝对误差）是 52.74，比之前最好的方法低了 4.8%（意味着人数预测更准）。
  - 在 NWPU-Crowd 数据集上，MAE 是 77.44，也比其他方法好。
- **定位准确性**：
  - 用 nAP 指标衡量，P2PNet 在大多数数据集上的 nAP（$\delta=0.5$）超过 80%，甚至接近 90%，说明定位很准。
  - 在 NWPU-Crowd 数据集上，P2PNet 的 F1 分数（综合定位指标）是 71.2%，比其他方法高。





## 5. **论文的贡献总结**

论文有三个主要贡献：

1. **新框架**：提出了一个“纯点框架”（purely point-based framework），直接用点来表示人，跳过了复杂的中间步骤（比如密度图或框）。
2. **新指标**：提出了 nAP，既看计数准不准，也看定位准不准。
3. **新方法**：设计了 P2PNet，通过一对一匹配直接预测点，效果比之前的方法好。



## 6. **论文的意义**

- **对研究者的意义**：P2PNet 提供了一个简单又高效的思路，证明了“直接预测点”在人群计数和定位任务中的可行性，可能会启发其他点预测任务（比如关键点检测）。
- **对实际应用的意义**：P2PNet 输出的点可以直接用于人群追踪、行为分析、安全监控等任务，非常实用。













