### 论文总结：重新思考人群中的计数与定位：一种纯粹基于点的框架

## 1. **传统方法的问题**

#### **1.1 密度图方法**：把人群想象成一片“人海”，用颜色深浅表示密度。

- **比喻**：就像你用热力图看一个地方的人群密度，红色表示人多，蓝色表示人少。你把所有颜色加起来，就能估算有多少人。
- **问题**：这种方法只能告诉你大概有多少人，但没法告诉你具体每个人的位置。比如你知道有 100 人，但不知道他们具体站在哪。

**论文中强调了：密度图的最大缺点就是无法预测人的精确位置。**

#### **1.2 检测方法**：用框框标记每个人的头部。

**论文中强调检测方法的缺点为**：然而，考虑到仅提供点注释，这些方法依赖启发式估算真实的边界框，这种方法容易出错，甚至不可行

#### 1.3 评估指标

**论文中也提出了传统的评估指标的缺点：**

>**传统普遍认同的评估指标（MAE 和 MSE）：**
>缺点：仅衡量计数误差，完全忽略单张图像中估计误差的显著空间变化。
>通俗解释：传统指标只看预测的总人数和真实人数差多少（比如预测 100 人，实际 110 人，差 10 个），但不关心这些预测点的位置是否正确。比如，预测的 100 个人可能都挤在图像左上角，而实际的 110 个人分布在整个图像，这种空间分布的误差完全被忽略了。
>数量：1 个缺点。
>**补丁级或像素级绝对计数误差（[9, 27, 37]）：**
>缺点：虽然试图解决空间变化问题，但只能提供粗略的定位评估。
>通俗解释：这些方法把图像分成小块（patch）或者逐像素计算误差，试图更细致地评估，但它们还是主要关注计数（每块有多少人），对定位（人具体在哪）评估不够精准。比如，它能告诉你某块区域人数预测错了，但没法告诉你预测点是不是真的靠近真实点。
>数量：1 个缺点。
>**平均定位误差（Mean Localization Error, [35]）：**
>缺点：仅评估定位误差，忽略计数误差。
>通俗解释：这个指标只看预测点和真实点之间的平均距离（比如平均偏了 5 个像素），但不关心人数对不对。比如，你可能预测了 100 个点，实际有 110 个人，虽然定位很准（平均偏 5 像素），但漏了 10 个人，这个错误它完全忽略。
>数量：1 个缺点。
>**贪心关联后的精度-召回曲线（[13]）：**
>缺点：忽略了对重复预测的惩罚。
>通俗解释：这种方法用贪心算法把预测点和真实点配对，然后算精度和召回率（Precision-Recall 曲线），但有个问题：如果一个真实点被多个预测点匹配（重复预测），它不会惩罚这种错误。比如，一个人被预测成了两个点，这种重复计数它不管。
>数量：1 个缺点。
>**序列匹配后使用标准 AP（[24]）：**
>缺点：文中没有明确指出其具体缺点，但提到它是为了改进 [13] 的问题（忽略重复预测）。可以推测，序列匹配虽然避免了贪心匹配的一些问题，但可能仍未解决其他问题（比如密度变化的影响），因为文中接着提出了 nAP 来解决密度变化问题。
>通俗解释：这种方法先按置信度排序预测点，然后依次匹配真实点，算平均精度（AP）。它比贪心匹配好一点，但可能还是没法很好处理人群密度变化大的情况（比如人多的地方和人少的地方，匹配规则应该不同）。
>数量：文中未明确指出具体缺点，但隐含 1 个缺点（未解决密度变化问题）。
>**其他隐含的缺点（针对所有传统方法）：**
>缺点：忽略人群密度变化大的问题。
>通俗解释：文中提到传统指标（包括 [35] 和 [13]）没有考虑人群密度变化的影响。比如，在人多的地方，点之间的距离很小，允许的误差应该小；在人少的地方，点之间的距离大，允许的误差可以大一些。传统方法没有针对密度做调整，导致评估不公平。
>数量：1 个缺点。

**补充，nAP指标相对于上面传统指标的优点**

>#### 新指标 nAP 的改进
>
>密度归一化平均精度（nAP），解决了上述问题：
>
>- 综合评估定位和计数：既看预测点的位置准不准，也看人数对不对。
>- 引入密度归一化：根据人群密度调整匹配规则，人多的地方要求更小的误差，人少的地方允许更大误差。
>- 使用序列匹配：避免重复预测（一个真实点只匹配一个预测点）。



## 2. **论文的创新：P2PNet 方法**

**论文强调P2PNet目标是：预测的点与真实点的距离尽可能近，置信度分数尽可能高。副产品是，预测的人数与真实的人数也尽可能接近。**

核心思想是：**直接预测点**

#### **2.1 具体步骤**：

1. **生成很多候选点（点提案）**

   - 模型先把照片分成一个个小格子（比如每 8 个像素一个格子）。
   - 每个格子里放几个“参考点”（比如 4 个点），这些点是预设的“候选人”。
   - **比喻**：就像你在照片上画一个网格，每个格子里放 4 个小旗子，这些小旗子是“可能有人”的位置。

2. **预测调整**

   - 模型有两个任务：
     - **定位**：预测每个小旗子需要移动多少距离，才能正好落在人的头顶上（偏移量）。
     - **分类**：给每个小旗子打一个分数（置信度），判断它是不是真的对应一个人（比如 0.9 表示很可能是人，0.1 表示不太可能是人）。
   - **比喻**：模型像一个侦探，告诉每个小旗子：“你需要往右移 2 步，往下移 1 步，就能找到一个人！”同时给它打分：“我 90% 确信这里有个人。”

3. **匹配**

   **问题是：当前的预测点到底应该对应哪个真实点？**

   > 论文在这里分析了传统匹配的缺点，如下：
   >
   > #### 第一种策略：对每个真实点，选择最近的预测点（1 v N 匹配）
   >
   > - 问题：可能会出现**多个真实点匹配到同一个预测点**
   > - 结果：由于预测点数量有限，这种方式可能会漏掉一些真实点，尤其在人群密集区域，导致**低估人数**。
   >
   > #### 第二种策略：对每个预测点，选择最近的真实点（N v 1 匹配）
   >
   > - 问题：可能会出现**多个预测点匹配到同一个真实点**
   > - 结果：由于缺乏尺度信息，无法轻易去除重复预测，导致**高估人数**。
   >
   > #### 第三种策略：我们提出的**一对一匹配**
   >
   > - **每个预测点只匹配一个真实点，反之亦然**，避免了以上两种策略的问题，适合直接点预测任务。未被匹配的预测点自动作为负样本（哪些预测点算是背景）

4. **训练和推理**

   - **训练时**：用真实点（标注数据）教模型怎么调整小旗子的位置和置信度。
   - **测试时**：模型直接输出调整后的点和置信度，然后挑置信度高的点（比如大于 0.5）作为最终结果。

#### 2.2**为什么这样更好？**

- **简单直接**：不需要中间步骤（比如密度图或框），直接预测点，减少了出错的机会。
- **准确**：通过一对一匹配，避免了“一个人被标记两次”或“漏掉人”的问题。
- **实用**：输出的点可以直接用于后续任务，比如追踪人群、分析行为。



## 3. **新的评价指标：nAP**

 **nAP**（density Normalized Average Precision，密度归一化平均精度）

#### 3.1 计算nAp

##### 1. **准备输入数据**

- 输入
  - 预测点集合 $  \hat{\mathcal{P}} = \{\hat{p}_j \mid j \in \{1, \ldots, M\}\}  $，每个预测点 $  \hat{p}_j = (\hat{x}_j, \hat{y}_j)  $ 表示模型预测的头部位置，附带一个置信度 $  \hat{c}_j  $（范围 0 到 1，比如 0.9 表示 90% 确信这里有个人）。
  - 真实点集合 $  \mathcal{P} = \{p_i \mid i \in \{1, \ldots, N\}\}  $，每个真实点 $  p_i = (x_i, y_i)  $ 表示标注的头部位置。



##### 2. **按置信度排序预测点**

- 将所有预测点 $  \hat{\mathcal{P}}  $ 按照置信度 $  \hat{c}_j  $ 从高到低排序。



##### 3. **计算每个真实点的密度（kNN 距离）**

- 对于每个真实点 $p_i$，计算它的 **k 最近邻距离**$d_{\mathrm{kNN}}(p_i)$：
  - 找到 $p_i$ 的 $k$ 个最近邻真实点（比如 $k=3$）。
  - 计算 $p_i$ 到这 $k$ 个邻居的平均欧几里得距离。
- **公式**： $d_{\mathrm{kNN}}(p_i) = \frac{1}{k} \sum_{\text{top } k \text{ neighbors of } p_i} \|p_i - p_{\text{neighbor}}\|_2$ 其中 $  \|p_i - p_{\text{neighbor}}\|_2  $ 是欧几里得距离： $\|p_i - p_{\text{neighbor}}\|_2 = \sqrt{(x_i - x_{\text{neighbor}})^2 + (y_i - y_{\text{neighbor}})^2}$



##### 4. **序列匹配：判断预测点是 TP 还是 FP**

正样本就是TP，负样本就是FP

- 按照置信度从高到低，依次检查每个预测点 $\hat{p}_j$：
  - 找到离 $  \hat{p}_j  $ 最近的真实点 $  p_i  $（用欧几里得距离 $  d(\hat{p}_j, p_i) = \|\hat{p}_j - p_i\|_2  $）。
  - 检查这个真实点 $p_i$ 是否已经被之前的预测点（置信度更高的）匹配过：
    - 如果 $  p_i  $ 已经被匹配过，$  \hat{p}_j  $ 就是 **False Positive (FP)**（错误的预测）。
    - 如果 $  p_i  $ 还没被匹配，计算归一化距离： $\text{归一化距离} = \frac{d(\hat{p}_j, p_i)}{d_{\mathrm{kNN}}(p_i)}$
    - 比较归一化距离和阈值 $\delta$（比如 $\delta = 0.5$:允许的偏差是 $d_{\mathrm{kNN}}(p_i)$ 的一半）：
      - **如果** $  \frac{d(\hat{p}_j, p_i)}{d_{\mathrm{kNN}}(p_i)} < \delta  $：$  \hat{p}_j  $ 是 **True Positive (TP)**（正确的预测），并标记 $  p_i  $ 为已匹配。
      - **否则**：$  \hat{p}_j  $ 是 **False Positive (FP)**。

>其实，在上面的匹配过程中，所用的“距离”可以不仅限于像素距离，也可以是**像素距离与置信度的组合成本函数**。我们在实验证明：在一对一匹配中**引入置信度作为匹配依据，有助于提升 nAP 指标的表现**。
>
>举例说明，设有两个预测点围绕同一个真实点 $p_i$：
>
>- 如果两者置信度一样，则应该优先将距离更近的点匹配为正样本，其它点为负样本，防止重复匹配。
>- 如果两者距离一样，则置信度更高的预测点应被匹配为正样本，并被进一步优化以获得更高精度和更高置信度。



##### 5. **计算精度和召回率，画 PR 曲线**

- 遍历所有预测点后，得到一个二进制列表：1 表示 TP，0 表示 FP。
- 计算累计的精度（Precision）和召回率（Recall）：
  - **Precision**：当前检查的点中，正确的比例。 $\text{Precision} = \frac{\text{累积 TP 数量}}{\text{累积 TP 数量} + \text{累积 FP 数量}}$
  - **Recall**：当前检查的点中，找到的真实点的比例。 $\text{Recall} = \frac{\text{累积 TP 数量}}{\text{真实点总数 } N}$
- 根据 Precision 和 Recall 画一条曲线（Precision-Recall 曲线）。
- **通俗解释**：你找了 100 个红点，其中 80 个是对的（TP），20 个是错的（FP），精度就是 $  80 / (80 + 20) = 0.8  $（80% 是对的）。召回率是 $  80 / 90 = 0.89  $（找到了 90 个真实点中的 80 个）。把这些点连成一条曲线。



##### 6. **计算 nAP**

- nAP 是 Precision-Recall 曲线下面的面积



##### 7. **多阈值 nAP**

- 论文中提到用不同的 $  \delta  $ 值（比如 0.05, 0.1, ..., 0.50）计算多个 nAP，然后取平均值，作为综合指标。

> 思考：论文中提到了nAP既可以评估定位也可以评估计数。nAP直接依赖于Precision和Recall，这两者直接依赖于真实点个数，TP和FP的个数.....



## 4. **实验结果：P2PNet表现如何？**

论文在几个数据集（比如 ShanghaiTech、UCF-QNRF、NWPU-Crowd）上测试了 P2PNet，结果非常好：

- **计数准确性**：
  - 在 ShanghaiTech PartA 数据集上，P2PNet 的 MAE（平均绝对误差）是 52.74，比之前最好的方法低了 4.8%（意味着人数预测更准）。
  - 在 NWPU-Crowd 数据集上，MAE 是 77.44，也比其他方法好。
- **定位准确性**：
  - 用 nAP 指标衡量，P2PNet 在大多数数据集上的 nAP（$\delta=0.5$）超过 80%，甚至接近 90%，说明定位很准。
  - 在 NWPU-Crowd 数据集上，P2PNet 的 F1 分数（综合定位指标）是 71.2%，比其他方法高。





## 5. **论文的贡献总结**

论文有三个主要贡献：

1. **新框架**：提出了一个“纯点框架”（purely point-based framework），直接用点来表示人，跳过了复杂的中间步骤（比如密度图或框）。
2. **新指标**：提出了 nAP，既看计数准不准，也看定位准不准。
3. **新方法**：设计了 P2PNet，通过一对一匹配直接预测点，效果比之前的方法好。



## 6. **论文的意义**

- **对研究者的意义**：P2PNet 提供了一个简单又高效的思路，证明了“直接预测点”在人群计数和定位任务中的可行性，可能会启发其他点预测任务（比如关键点检测）。
- **对实际应用的意义**：P2PNet 输出的点可以直接用于人群追踪、行为分析、安全监控等任务，非常实用。













